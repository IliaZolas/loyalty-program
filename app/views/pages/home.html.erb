<% if user_signed_in? %>
<div class="bg-gradient">
    <div class="container">
        <div class="flex">
            <!-- Simulated purchase form -->
            <div>
                <h2>Simulate a Purchase</h2>
                <%= form_with url: transactions_path, scope: :transaction, local: true do |f| %>
                <div>
                    <%= f.label :amount_cents, "Amount (cents)" %><br>
                    <%= f.number_field :amount_cents, value: 10000, min: 0, class: "purchase-form-inputs" %>
                </div>
                <div>
                    <%= f.label :country_code %><br>
                    <%= f.text_field :country_code, value: "US", class: "purchase-form-inputs" %>
                </div>
                <div>
                    <%= f.label :occurred_at, "When" %><br>
                    <%= f.datetime_select :occurred_at, default: Time.current, class: "purchase-form-inputs" %>
                </div>
                <%= f.submit "Submit Purchase", class: "buttons" %>
                <% end %>
            </div>

            <!-- Display flashâ€‘driven results -->
            <div>
                <h2>New Rewards</h2>
                <% if flash[:points_awarded] %>
                    <p><strong>Points for this purchase:</strong> <%= flash[:points_awarded] %></p>
                    <p><strong>Total points:</strong><%= flash[:total_points] %></p>

                    <% rewards = flash[:new_rewards] || [] %>
                    <% if rewards.any? %>
                        <p><strong>New Rewards Unlocked!</strong></p>
                        <ul>
                            <% rewards.each do |r| %>
                                <li>
                                <strong><%= (r[:type] || r['type']).to_s.humanize %></strong>
                                </li>
                            <% end %>
                        </ul>
                    <% else %>
                        <p>No new rewards this time.</p>
                    <% end %>
                <% else %>
                    <p>No new rewards this time.</p>
            <% end %>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <h2>Rewards History</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Issued At</th>
                    </tr>
                </thead>
                <tbody>
                    <% @rewards.each do |reward| %>
                        <tr>
                            <td><%= reward.reward_type.humanize %></td>
                            <td><%= reward.created_at.strftime("%Y-%m-%d %H:%M") %></td>
                        </tr>
                    <% end %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<% else %>

<!-- Existing public home content -->
<div class="bg-gradient">
    <div class="container">
        <h1>Welcome to the Loyalty Reward App!</h1>
        <%= link_to "Log in", new_user_session_path, class: "buttons" %>
    </div>
</div>
<% end %>
